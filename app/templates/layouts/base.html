<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}VnExpress Analyzer{% endblock %}</title>
    {# Link đến Tailwind CSS (CDN hoặc file đã build) #}
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    {# Link đến Font Awesome cho icons #}
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    {# Link đến file CSS tùy chỉnh của bạn (nếu có) #}
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
    <style>
      /* Thêm một chút CSS tùy chỉnh nếu cần */
      .prose img {
        margin-top: 1em;
        margin-bottom: 1em;
      } /* Căn chỉnh ảnh trong nội dung bài viết */

      #suggestions-box {
        background: #f8fafc; /* Tailwind slate-50 */
        border: 1px solid #cbd5e1; /* Tailwind slate-300 */
        color: #1e293b; /* Tailwind slate-800 */
      }
      #suggestions-box div {
        transition: background 0.15s;
      }
      #suggestions-box div:hover,
      #suggestions-box div.active {
        background: #e0e7ef; /* Tailwind blue-100 */
        color: #2563eb; /* Tailwind blue-600 */
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans">
    <!-- Header/Navbar -->
    <header class="bg-blue-700 text-white shadow-md">
      <nav
        class="container mx-auto px-4 py-3 flex justify-between items-center"
      >
        <a
          href="{{ url_for('main.index') }}"
          class="text-2xl font-bold hover:text-yellow-300 transition"
        >
          <i class="fas fa-newspaper mr-2"></i>VnExpress Analyzer
        </a>
        <div
          class="flex items-center space-x-4 w-full justify-end md:justify-normal"
        >
          <!-- DateTime Display -->
          <div
            id="datetime-display"
            class="px-3 py-1 bg-blue-600 text-white rounded-full shadow text-sm font-semibold flex items-center mr-2 md:mr-6"
          >
            <i class="far fa-clock mr-2"></i>
            <span id="current-datetime"></span>
          </div>
          <div class="hidden md:flex space-x-6 items-center">
            <a href="{{ url_for('main.index') }}" class="hover:text-yellow-300"
              >Home</a
            >
            {# <a href="#" class="hover:text-yellow-300">Explore Topics</a> #}
            {# <a href="#" class="hover:text-yellow-300">Analyze New</a> #}
          </div>
          <div class="w-full md:w-1/3 flex justify-end">
            <form
              method="GET"
              action="{{ url_for('main.index') }}"
              class="relative flex w-full md:w-auto"
              autocomplete="off"
            >
              <input
                type="search"
                name="q"
                id="search-input"
                value="{{ request.args.get('q', '') }}"
                placeholder="Search articles..."
                class="w-full md:w-64 bg-white text-gray-800 placeholder-gray-400 rounded-full py-2 px-4 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-400 border border-gray-300 shadow-sm"
                oninput="showSuggestions(this.value)"
                autocomplete="off"
              />
              <button
                type="submit"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800"
              >
                <i class="fas fa-search"></i>
              </button>
              <div
                id="suggestions-box"
                class="absolute left-0 right-0 top-full w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 hidden"
              ></div>
            </form>
          </div>
          <div class="md:hidden">
            <button
              id="mobile-menu-button"
              class="text-white focus:outline-none"
            >
              <i class="fas fa-bars fa-lg"></i>
            </button>
          </div>
        </div>
      </nav>
      <!-- Mobile Menu (ẩn mặc định) -->
      <div id="mobile-menu" class="md:hidden hidden bg-blue-600">
        <a
          href="{{ url_for('main.index') }}"
          class="block py-2 px-4 text-sm hover:bg-blue-500"
          >Home</a
        >
        {#
        <a href="#" class="block py-2 px-4 text-sm hover:bg-blue-500"
          >Explore Topics</a
        >
        #}
      </div>
    </header>

    <!-- Flash Messages -->
    <div class="container mx-auto px-4 mt-4">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="p-4 mb-4 text-sm rounded-lg {% if category == 'danger' %} bg-red-100 text-red-700 {% elif category == 'success' %} bg-green-100 text-green-700 {% elif category == 'warning' %} bg-yellow-100 text-yellow-700 {% else %} bg-blue-100 text-blue-700 {% endif %}"
        role="alert"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <!-- Main Content Block -->
    <main>{% block content %}{% endblock %}</main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-300 py-12 mt-16">
      <div class="container mx-auto px-4 text-center">
        <p>© {{ current_year }} VnExpress Analyzer. All rights reserved.</p>
        <p class="text-sm mt-2">
          A project for learning and demonstration purposes.
        </p>
        {# Thêm các link Quick Links, Resources, Connect như phác thảo nếu muốn
        #}
      </div>
    </footer>

    <script>
      // Basic Mobile Menu Toggle
      const menuButton = document.getElementById("mobile-menu-button");
      const mobileMenu = document.getElementById("mobile-menu");
      if (menuButton && mobileMenu) {
        menuButton.addEventListener("click", () => {
          mobileMenu.classList.toggle("hidden");
        });
      }

      async function showSuggestions(query) {
        const box = document.getElementById("suggestions-box");
        if (!query || query.length < 2) {
          box.classList.add("hidden");
          box.innerHTML = "";
          return;
        }
        try {
          const resp = await fetch(
            `/search-suggest?q=${encodeURIComponent(query)}`
          );
          if (!resp.ok) throw new Error("Network error");
          const data = await resp.json();
          if (data.suggestions && data.suggestions.length > 0) {
            const keywords = data.keywords || [];
            box.innerHTML = data.suggestions
              .map((s) => {
                // Chỉ loại bỏ ký tự xuống dòng, tab, giữ nguyên dấu cách hợp lệ
                let label = s.value.replace(/[\n\r\t]+/g, " ").trim();
                // Highlight keyword
                keywords.forEach((kw) => {
                  if (kw.length > 0) {
                    const re = new RegExp(
                      `(${kw.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
                      "gi"
                    );
                    label = label.replace(
                      re,
                      '<span class="font-bold text-blue-600">$1</span>'
                    );
                  }
                });
                let icon = "";
                if (s.type === "category")
                  icon = '<i class="fas fa-tag text-yellow-500 mr-2"></i>';
                if (s.type === "author")
                  icon = '<i class="fas fa-user text-green-600 mr-2"></i>';
                return `<div class='px-4 py-2 hover:bg-blue-100 cursor-pointer flex items-center whitespace-nowrap' onclick=\"document.getElementById('search-input').value='${s.value
                  .replace(/'/g, "\\'")
                  .replace(/[\n\r\t]+/g, " ")
                  .trim()}'; document.querySelector('form[method=GET]').submit();\">${icon}${label}</div>`;
              })
              .join("");
            box.classList.remove("hidden");
          } else {
            box.classList.add("hidden");
            box.innerHTML = "";
          }
        } catch (e) {
          box.classList.add("hidden");
          box.innerHTML = "";
        }
      }
      // Hide suggestions when clicking outside
      document.addEventListener("click", function (e) {
        const box = document.getElementById("suggestions-box");
        if (!box.contains(e.target) && e.target.id !== "search-input") {
          box.classList.add("hidden");
        }
      });

      // Lấy danh sách bài viết mới nhất (có thể mở rộng hoặc thay đổi theo nhu cầu)
      async function fetchLatestArticles() {
        try {
          const resp = await fetch("/api/latest-articles");
          if (!resp.ok) throw new Error("Không lấy được dữ liệu bài viết");
          const data = await resp.json();
          const articlesContainer = document.getElementById("latest-articles");
          articlesContainer.innerHTML = data.articles
            .map(
              (a) => `<div class="mb-4 p-4 bg-white rounded-lg shadow">
                <a href="/article/${
                  a.id
                }" class="text-lg font-semibold text-blue-600 hover:text-blue-800"
                  >${a.title}</a
                >
                <p class="text-sm text-gray-500 mt-1">
                  ${new Date(a.published_at).toLocaleString("vi-VN")}
                </p>
              </div>`
            )
            .join("");
        } catch (e) {
          console.error(e);
        }
      }

      function updateDateTime() {
        const now = new Date();
        document.getElementById("current-datetime").textContent =
          now.toLocaleString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });
      }
      setInterval(updateDateTime, 1000);
      updateDateTime();

      document.addEventListener("DOMContentLoaded", function () {
        fetchLatestArticles();
      });
    </script>
  </body>
</html>
