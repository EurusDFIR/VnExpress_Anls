{% extends "layouts/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 animate-fade-in">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-400 text-white p-8 md:p-12 rounded-2xl shadow-2xl mb-12 relative overflow-hidden animate-slide-down">
        <div class="absolute right-0 top-0 opacity-20 pointer-events-none select-none hidden md:block">
            <i class="fas fa-chart-line fa-8x"></i>
        </div>
        <h1 class="text-4xl md:text-5xl font-extrabold mb-4 drop-shadow-lg">
          Deep Insights into VnExpress News
        </h1>
        <p class="text-lg md:text-xl mb-8 font-medium">
          Analyze sentiment, topics, and community interactions for any VnExpress article
        </p>
        <form method="POST" action="{{ url_for('main.analyze_new_article') }}" class="flex flex-col sm:flex-row items-center gap-4">
            <input type="url" name="article_url" placeholder="Paste VnExpress article URL..."
                   class="flex-grow p-4 rounded-full text-gray-800 focus:ring-4 focus:ring-yellow-400 focus:outline-none shadow-lg transition-all duration-200" required>
            <div class="flex flex-col items-start gap-2 bg-white bg-opacity-20 rounded-xl px-4 py-3 shadow-lg border border-yellow-200 animate-fade-in">
                <label class="inline-flex items-center text-blue-900 font-semibold cursor-pointer select-none">
                    <input type="checkbox" name="scrape_comments" id="scrape_comments_cb" class="form-checkbox h-5 w-5 text-yellow-400 rounded focus:ring-yellow-500 transition-all duration-150">
                    <span class="ml-2 flex items-center">
                        <i class="far fa-comments mr-1 text-yellow-400 animate-bounce"></i>
                        Scrape bình luận
                    </span>
                </label>
                <div id="max_comments_box" class="w-full mt-1 transition-all duration-200" style="display:none;">
                    <label for="max_comments" class="text-sm text-blue-900 font-medium mb-1">Số bình luận tối đa</label>
                    <input type="number" name="max_comments" id="max_comments" min="1" max="500" value="100" class="w-32 p-2 rounded text-gray-800 border border-gray-300 focus:ring-2 focus:ring-yellow-400" placeholder="Tối đa 500">
                </div>
                <span class="text-xs text-blue-100 mt-1">Tùy chọn này sẽ làm quá trình phân tích chậm hơn nếu bài viết có nhiều bình luận.</span>
            </div>
            <button type="submit"
                    class="bg-yellow-400 hover:bg-yellow-500 text-blue-800 font-bold py-4 px-8 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-search-plus mr-2"></i> Analyze Now
            </button>
        </form>
    </div>

    <!-- Filter and Sort Section -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8 animate-fade-in">
        <form method="GET" action="{{ url_for('main.index') }}" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
            <input type="hidden" name="q" value="{{ request.args.get('q', '') }}" />
            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Filter by Category</label>
                <select id="category" name="category"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all duration-150">
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat == current_category %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                <div class="flex items-center space-x-2">
                    <input type="date" id="date_from" name="date_from" value="{{ current_date_from or '' }}"
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all duration-150">
                    <span class="text-gray-500">to</span>
                    <input type="date" id="date_to" name="date_to" value="{{ current_date_to or '' }}"
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all duration-150">
                </div>
            </div>
            <div>
                <label for="sort_by" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                <select id="sort_by" name="sort_by"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all duration-150">
                    <option value="newest_first" {% if current_sort_by == 'newest_first' %}selected{% endif %}>Newest First</option>
                    <option value="oldest_first" {% if current_sort_by == 'oldest_first' %}selected{% endif %}>Oldest First</option>
                    <option value="most_comments" {% if current_sort_by == 'most_comments' %}selected{% endif %}>Most Comments</option>
                </select>
            </div>
            <div class="md:col-start-4 lg:col-start-4">
                 <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full shadow focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-150 transform hover:scale-105">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Latest Analyzed Articles Section -->
    <h2 class="text-3xl font-semibold text-gray-800 mb-6 animate-slide-up">Latest Analyzed Articles</h2>
    {% if articles %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for article in articles %}
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col transform hover:scale-105 hover:shadow-2xl transition-all duration-300 animate-fade-in">
            <img src="{{ article.image_url or url_for('static', filename='images/article_placeholder.png') }}" alt="Article thumbnail" class="w-full h-48 object-cover">
            <div class="p-6 flex flex-col flex-grow">
                <div class="flex justify-between items-center mb-2">
                    {% if article.category %}
                    <span class="px-2 py-1 bg-blue-100 text-blue-600 text-xs font-semibold rounded-full shadow">{{ article.category }}</span>
                    {% endif %}
                    {% if article.publish_datetime %}
                    <span class="text-xs text-gray-500">{{ article.publish_datetime.strftime('%b %d, %Y') }}</span> 
                    {% elif article.published_date_str %}
                     <span class="text-xs text-gray-500">{{ article.published_date_str.split(',')[1] if ',' in article.published_date_str else article.published_date_str }}</span>
                    {% endif %}
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2 hover:text-blue-600 transition duration-150">
                    <a href="{{ url_for('main.article_detail', article_id=article.id) }}">{{ article.title or 'N/A' }}</a>
                </h3>
                <p class="text-gray-600 text-sm mb-4 flex-grow">{{ (article.sapo or article.content or '')[:150] }}{% if (article.sapo or article.content or '')|length > 150 %}...{% endif %}</p>
                <div class="flex items-center justify-between text-sm text-gray-500 mt-auto">
                    <div class="flex items-center">
                        {% if article.sentiment_score and article.sentiment_score > 0.1 %}
                            <span class="text-green-500 mr-1 animate-bounce"><i class="far fa-smile"></i></span>
                        {% elif article.sentiment_score and article.sentiment_score < -0.1 %}
                            <span class="text-red-500 mr-1 animate-bounce"><i class="far fa-frown"></i></span>
                        {% else %}
                            <span class="text-yellow-500 mr-1 animate-bounce"><i class="far fa-meh"></i></span> 
                        {% endif %}
                        <span>{{ article.total_comments_count or 0 }} <i class="far fa-comments ml-1"></i></span>
                    </div>
                    <a href="{{ url_for('main.article_detail', article_id=article.id) }}" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-150">
                        View Analysis <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="mt-12">
        {% if pagination %}
        <nav class="flex justify-center">
            <ul class="inline-flex items-center -space-x-px">
                <li>
                    <a href="{{ url_for('main.index', page=pagination.prev_num) if pagination.has_prev else '#' }}"
                       class="py-2 px-3 ml-0 leading-tight text-gray-500 bg-white rounded-l-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700
                              {% if not pagination.has_prev %} opacity-50 cursor-not-allowed {% endif %} transition-all duration-150">
                        Previous
                    </a>
                </li>
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        {% if pagination.page == page_num %}
                        <li>
                            <a href="#" aria-current="page"
                               class="z-10 py-2 px-3 leading-tight text-blue-600 bg-blue-50 border border-blue-300 hover:bg-blue-100 hover:text-blue-700 transition-all duration-150">
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li>
                            <a href="{{ url_for('main.index', page=page_num) }}"
                               class="py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 transition-all duration-150">
                                {{ page_num }}
                            </a>
                        </li>
                        {% endif %}
                    {% else %}
                    <li class="disabled"><span class="py-2 px-3 leading-tight text-gray-400">…</span></li>
                    {% endif %}
                {% endfor %}
                <li>
                    <a href="{{ url_for('main.index', page=pagination.next_num) if pagination.has_next else '#' }}"
                       class="py-2 px-3 leading-tight text-gray-500 bg-white rounded-r-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700
                              {% if not pagination.has_next %} opacity-50 cursor-not-allowed {% endif %} transition-all duration-150">
                        Next
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
    {% else %}
    <p class="text-center text-gray-600 animate-fade-in">No articles found matching your criteria or no articles have been analyzed yet.</p>
    {% endif %}
</div>
    <!-- === START: Development Team Section === -->
    {% if page_team_info %} {# Chỉ hiển thị nếu có thông tin đội ngũ #}
    <section class="py-16 md:py-24 bg-gradient-to-br from-slate-50 to-sky-100 rounded-2xl shadow-xl mt-12 md:mt-20 animate-fade-in">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12 md:mb-16">
                <h2 class="text-4xl md:text-5xl font-extrabold text-sky-700 mb-4 tracking-tight">
                    Gặp Gỡ Đội Ngũ Phát Triển
                </h2>
                <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">
                    Sản phẩm là kết quả đạt được của nhóm 3 với mong muốn đáp ứng được nhu cầu tiếp nhận thông tin báo chí trong nước một cách nhanh chóng và trực quan, đem đến trải nghiệm mới mẻ, phù hợp với thời buổi phát triển số.
                </p>
                 {% if page_team_info.team_photo %}
                <img src="{{ url_for('static', filename=page_team_info.team_photo) }}" alt="Team Photo" class="mt-8 mx-auto rounded-xl shadow-lg max-w-lg w-full h-auto object-cover border-4 border-white">
                {% endif %}
            </div>

            <!-- Giảng viên hướng dẫn -->
            <div class="text-center mb-12 md:mb-16">
                <h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3">
                    <i class="fas fa-user-tie text-sky-600 mr-2"></i>Giảng Viên Hướng Dẫn
                </h3>
                <div class="inline-block bg-white p-6 rounded-xl shadow-lg border border-sky-300 max-w-md mx-auto">
                    <p class="text-xl font-semibold text-sky-700">{{ page_team_info.lecturer }}</p>
                    <!-- Thêm thông tin khác về giảng viên nếu muốn, ví dụ: Khoa, Trường -->
                    <!-- <p class="text-sm text-gray-500 mt-1">Khoa Công nghệ Thông tin - Trường Đại học XYZ</p> -->
                </div>
            </div>

            <!-- Danh sách thành viên -->
            {% if page_team_info.members %}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
                {% for member in page_team_info.members %}
                <div class="bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col group transform transition-all duration-300 hover:-translate-y-2 hover:shadow-sky-400/50">
                    <div class="relative h-64 bg-slate-700"> {# Tăng chiều cao ảnh một chút #}
                        <img src="{{ url_for('static', filename=(member.avatar or 'images/avatars/hoang.png')) }}" 
                             alt="Ảnh đại diện {{ member.name }}" 
                             class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-400 ease-in-out">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent flex flex-col justify-end p-4">
                            <h3 class="text-2xl font-bold text-white drop-shadow-lg">{{ member.name }}</h3>
                            {% if member.role %}
                            <p class="text-sm text-sky-300 font-medium">{{ member.role }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="p-6 flex-grow flex flex-col text-center">
                        {% if member.bio %}
                        <p class="text-gray-600 text-sm mb-4 flex-grow italic">"{{ member.bio }}"</p>
                        {% endif %}
                        
                        <div class="mt-auto">
                            {% if member.mssv %}
                            <p class="text-xs text-gray-500 mb-3">MSSV: {{ member.mssv }}</p>
                            {% endif %}
                            <div class="flex space-x-4 justify-center">
                                {% if member.google %}
                                <a href="{{ member.google }}" target="_blank" rel="noopener noreferrer"
                                   class="text-sky-600 hover:text-sky-800 transition-colors duration-200 text-2xl transform hover:scale-110" title="Google">
                                    <i class="fab fa-google"></i>
                                </a>
                                {% endif %}
                                {% if member.github %}
                                <a href="{{ member.github }}" target="_blank" rel="noopener noreferrer"
                                   class="text-gray-700 hover:text-black transition-colors duration-200 text-2xl transform hover:scale-110" title="GitHub">
                                    <i class="fab fa-github-square"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %} {# Kết thúc if page_team_info.members #}
        </div>
    </section>
    {% endif %} {# Kết thúc if page_team_info #}
    <!-- === END: Development Team Section === -->

</div> <!-- Thẻ đóng của <div class="container mx-auto px-4 py-8 animate-fade-in"> -->

<!-- Loading Spinner Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-70 flex flex-col items-center justify-center z-50 hidden">
  <div class="flex flex-col items-center">
    <svg class="animate-spin h-12 w-12 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <span class="text-lg text-blue-700 font-semibold animate-pulse">Đang tải dữ liệu, vui lòng chờ...</span>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var forms = document.querySelectorAll("form[method='POST']");
    forms.forEach(function (form) {
      form.addEventListener("submit", function () {
        document.getElementById("loading-overlay").classList.remove("hidden");
      });
    });
  
  });

  document.addEventListener("DOMContentLoaded", function () {
      var cb = document.getElementById("scrape_comments_cb");
      var box = document.getElementById("max_comments_box");
      if(cb && box) {
          cb.addEventListener("change", function() {
              if(cb.checked) {
                  box.style.display = "block";
              } else {
                  box.style.display = "none";
              }
          });
      }
  });
</script>

<style>
@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}
.animate-fade-in {
  animation: fade-in 1s ease;
}
@keyframes slide-down {
  from { transform: translateY(-40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.animate-slide-down {
  animation: slide-down 0.8s cubic-bezier(0.4,0,0.2,1);
}
@keyframes slide-up {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.animate-slide-up {
  animation: slide-up 0.8s cubic-bezier(0.4,0,0.2,1);
}
</style>
{% endblock %}